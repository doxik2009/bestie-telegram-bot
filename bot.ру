import os
import random
from dataclasses import dataclass
from typing import Dict, List

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes
)

# ======================
# –ö–ê–†–¢–´ –ò–ì–†–´
# ======================

COFFEE_CARDS = [
    "–ö—Ç–æ –∏–∑ –≤–∞—Å –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π —Å–ø–æ–∫–æ–π–Ω–æ–π, –Ω–æ —ç—Ç–æ –æ–±–º–∞–Ω?",
    "–° –∫–µ–º –∏–∑ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç—ã –±—ã –ø–æ—à–ª–∞ –Ω–∞ –∫–æ—Ñ–µ —Ç–µ—Ç-–∞-—Ç–µ—Ç?",
    "–ö—Ç–æ —Ç–æ—á–Ω–æ –Ω–∞–ø–∏—à–µ—Ç –ø–µ—Ä–≤–æ–π –ø–æ—Å–ª–µ –≤—Å—Ç—Ä–µ—á–∏?",
    "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ ¬´—è —Ö–æ—Ä–æ—à–∞—è¬ª, –Ω–æ –º–æ–∂–µ—Ç —É–¥–∏–≤–∏—Ç—å?",
    "–ö—Ç–æ –∏–∑ –≤–∞—Å —É–º–µ–µ—Ç —Å–ª—É—à–∞—Ç—å, –Ω–æ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –í–°–Å?",
    "–° –∫–µ–º —Ç–µ–±–µ —É–∂–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ, —Ö–æ—Ç—è –≤—ã —Ç–æ–ª—å–∫–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç –∏—Å—á–µ–∑–Ω—É—Ç—å –Ω–∞ –º–µ—Å—è—Ü –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫–∞–∫ –Ω–∏ –≤ —á—ë–º –Ω–µ –±—ã–≤–∞–ª–æ?",
    "–ö—Ç–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ ¬´–Ω–∞–¥—ë–∂–Ω–æ–π –ø–æ–¥—Ä—É–≥–∏¬ª?",
    "–° –∫–µ–º –±—ã —Ç—ã –ø–æ—à–ª–∞ –≥—É–ª—è—Ç—å –±–µ–∑ –ø–ª–∞–Ω–∞?",
    "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π —Ä–∞—Å—Å—É–¥–∏—Ç–µ–ª—å–Ω–æ–π?",
    "–ö—Ç–æ —É–º–µ–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Å–ª–æ–≤–∞–º–∏?",
    "–ö—Ç–æ –±–æ–ª—å—à–µ –ø—Ä–æ ¬´–¥–∞–≤–∞–π –æ–±—Å—É–¥–∏–º¬ª?",
    "–ö—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—â—É—â–µ–Ω–∏–µ ¬´–º—ã –±—ã –ø–æ–¥—Ä—É–∂–∏–ª–∏—Å—å¬ª?",
    "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Å–∞–º–æ–π —Å–æ–±—Ä–∞–Ω–Ω–æ–π?",
    "–° –∫–µ–º —Ç—ã –±—ã –ø–æ–¥–µ–ª–∏–ª–∞—Å—å –ª–∏—á–Ω—ã–º?",
    "–ö—Ç–æ —Å–∫–æ—Ä–µ–µ –ø—Ä–æ–º–æ–ª—á–∏—Ç, —á–µ–º –±—É–¥–µ—Ç —Å–ø–æ—Ä–∏—Ç—å?",
    "–ö—Ç–æ –∏–∑ –≤–∞—Å —Å–∞–º–∞—è —Ç–∞–∫—Ç–∏—á–Ω–∞—è?",
    "–ö—Ç–æ —É–º–µ–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —É—é—Ç –≤–æ–∫—Ä—É–≥ —Å–µ–±—è?",
    "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π?",
    "–ö—Ç–æ —Å–∫–æ—Ä–µ–µ –∑–∞ –º–∏—Ä, —á–µ–º –∑–∞ –¥—Ä–∞–º—É?",
    "–° –∫–µ–º —Ç—ã –±—ã –ø–æ–µ—Ö–∞–ª–∞ –≤ –∫–æ—Ä–æ—Ç–∫—É—é –ø–æ–µ–∑–¥–∫—É?",
    "–ö—Ç–æ —É–º–µ–µ—Ç —Å–≥–ª–∞–∂–∏–≤–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã?",
    "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ ¬´–¥—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏¬ª, –Ω–æ —Ç–∏—Ö–æ?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç –¥–∞—Ç—å —Ö–æ—Ä–æ—à–∏–π —Å–æ–≤–µ—Ç?",
    "–ö—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ?",
    "–° –∫–µ–º –ø—Ä–∏—è—Ç–Ω–æ –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞—Ç—å?",
    "–ö—Ç–æ –±–æ–ª—å—à–µ –∑–∞ —á–µ—Å—Ç–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã?",
    "–ö—Ç–æ —É–º–µ–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –±–µ–∑ —Å–ª–æ–≤?",
    "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Å–∞–º–æ–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–π?",
    "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π –∏—Å–∫—Ä–µ–Ω–Ω–µ–π?",
    "–° –∫–µ–º —Ç—ã –±—ã –ø–æ—à–ª–∞ –Ω–∞ –¥–æ–ª–≥—É—é –ø—Ä–æ–≥—É–ª–∫—É?",
    "–ö—Ç–æ —É–º–µ–µ—Ç —Å–ª—ã—à–∞—Ç—å –¥—Ä—É–≥–∏—Ö?",
    "–ö—Ç–æ —Å–∫–æ—Ä–µ–µ –∑–∞ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å?",
    "–ö—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –æ—â—É—â–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏?",
    "–ö—Ç–æ –±–æ–ª—å—à–µ –∑–∞ –≥–ª—É–±–æ–∫–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã?",
    "–° –∫–µ–º —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—â–µ–Ω–∏–µ?",
    "–ö—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç —á—É–≤—Å—Ç–≤–æ —Ç–µ–ø–ª–∞?",
    "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –±—É–¥—É—â–∞—è –ø–æ–¥—Ä—É–≥–∞?",
    "–ö—Ç–æ —É–º–µ–µ—Ç –±—ã—Ç—å —Ä—è–¥–æ–º?",
    "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π –Ω–∞–¥—ë–∂–Ω–æ–π?",
]

WINE_CARDS = [
    "–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è —Å–∫–∞–∂–µ—Ç: ¬´—è –≤–æ–æ–±—â–µ-—Ç–æ –Ω–µ —Ç–∞–∫–∞—è¬ª?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç —É—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ –Ω–∏—á–µ–≥–æ?",
    "–ö—Ç–æ –∑–Ω–∞–µ—Ç –≤—Å–µ —Å–ø–ª–µ—Ç–Ω–∏, –Ω–æ –º–æ–ª—á–∏—Ç?",
    "–ö—Ç–æ –ø–µ—Ä–≤–∞—è –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç —Ä–µ–∑–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–ª–∞–Ω—ã?",
    "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∏—Ö–æ–π, –Ω–æ —ç—Ç–æ –ª–æ–≤—É—à–∫–∞?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –±—ã–≤—à–µ–º—É –ø–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–≥–æ –±–æ–∫–∞–ª–∞?",
    "–ö—Ç–æ —Ç–æ—á–Ω–æ —É–º–µ–µ—Ç –≤–µ—Å–µ–ª–∏—Ç—å—Å—è?",
    "–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è —Å–∞–º–∞—è –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç –≤—Ç—è–Ω—É—Ç—å –≤ –∞–≤–∞–Ω—Ç—é—Ä—É?",
    "–ö—Ç–æ –ª—é–±–∏—Ç –¥—Ä–∞–º—É, –Ω–æ –æ—Ç—Ä–∏—Ü–∞–µ—Ç —ç—Ç–æ?",
    "–ö—Ç–æ —Å–∫–∞–∂–µ—Ç –ø—Ä–∞–≤–¥—É –≤ –ª–∏—Ü–æ?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç —Ä–∞—Å—Å–º–µ—à–∏—Ç—å –≤—Å–µ—Ö?",
    "–ö—Ç–æ –±–æ–ª—å—à–µ –∑–∞ ¬´–∞ –¥–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º¬ª?",
    "–ö—Ç–æ —É–º–µ–µ—Ç –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –≤–µ—á–µ—Ä –≤ –∏—Å—Ç–æ—Ä–∏—é?",
    "–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Ö–∞–æ—Å–∞?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç —Ñ–ª–∏—Ä—Ç–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫?",
    "–ö—Ç–æ —É–º–µ–µ—Ç –±—ã—Ç—å –¥–µ—Ä–∑–∫–æ–π –∫—Ä–∞—Å–∏–≤–æ?",
    "–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è —Å–∞–º–∞—è —Å–º–µ–ª–∞—è?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ —É–µ—Ö–∞—Ç—å –Ω–æ—á—å—é?",
    "–ö—Ç–æ —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—Ç, —á–µ–≥–æ —Ö–æ—á–µ—Ç (–∏–ª–∏ –¥–µ–ª–∞–µ—Ç –≤–∏–¥)?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–∏ –æ —á—ë–º –∏ —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º?",
    "–ö—Ç–æ –ª—é–±–∏—Ç –≤–Ω–∏–º–∞–Ω–∏–µ, –Ω–æ —Å–∫—Ä—ã–≤–∞–µ—Ç —ç—Ç–æ?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç —Å–∫–∞–∑–∞—Ç—å –ª–∏—à–Ω–µ–≥–æ ‚Äî –Ω–æ —Å–º–µ—à–Ω–æ?",
    "–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –≤ —Ä–µ–∂–∏–º–µ ¬´–±–µ—Å—Ç–∏—è¬ª?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –Ω–µ–ª–æ–≤–∫–æ—Å—Ç—å –≤ —à—É—Ç–∫—É?",
    "–ö—Ç–æ –±–æ–ª—å—à–µ –∑–∞ —ç–º–æ—Ü–∏–∏, —á–µ–º –∑–∞ –ª–æ–≥–∏–∫—É?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç –≤–Ω–µ–∑–∞–ø–Ω–æ –ø—Ä–∏–∑–Ω–∞—Ç—å—Å—è –≤ —á—ë–º-—Ç–æ?",
    "–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –∑–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç—å –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∞—Å–Ω–æ –æ—á–∞—Ä–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π?",
    "–ö—Ç–æ —É–º–µ–µ—Ç –≤–µ—Å–µ–ª–∏—Ç—å—Å—è –±–µ–∑ —Ç–æ—Ä–º–æ–∑–æ–≤?",
    "–ö—Ç–æ –ª—é–±–∏—Ç —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞?",
    "–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è —Å–∞–º–∞—è –≥—Ä–æ–º–∫–∞—è (–¥–∞–∂–µ –µ—Å–ª–∏ –º–æ–ª—á–∏—Ç)?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ª—é–±–æ–π –¥–≤–∏–∂?",
    "–ö—Ç–æ –ª—é–±–∏—Ç —Ä–∏—Å–∫, –Ω–æ –∫—Ä–∞—Å–∏–≤–æ?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç —Å–∫–∞–∑–∞—Ç—å ¬´–∞ –ø–æ—á–µ–º—É –±—ã –∏ –Ω–µ—Ç¬ª?",
    "–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –≥–ª–∞–≤–Ω—ã–π –≤–∞–π–± –≤–µ—á–µ—Ä–∞?",
    "–ö—Ç–æ –º–æ–∂–µ—Ç —É–¥–∏–≤–∏—Ç—å –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ–º?",
    "–ö—Ç–æ —Ç–æ—á–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ —ç—Ç–æ–π –≤—Å—Ç—Ä–µ—á–∏?",
]

# ======================
# –ü–†–ê–í–ò–õ–ê
# ======================

RULES_TEXT = (
    "üé¥ *–ú–ï–ñ–î–£ –ù–ê–ú–ò, –î–ï–í–û–ß–ö–ê–ú–ò*\n\n"
    "–ü—Ä–∞–≤–∏–ª–∞:\n"
    "‚Ä¢ –ò–≥—Ä–∞ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–π 2‚Äì10 —á–µ–ª–æ–≤–µ–∫\n"
    "‚Ä¢ –ò–≥—Ä–∞–µ–º –ø–æ –æ—á–µ—Ä–µ–¥–∏\n"
    "‚Ä¢ –û—Ç–≤–µ—á–∞–µ–º —á–µ—Å—Ç–Ω–æ –∏–ª–∏ —Å–º–µ—à–Ω–æ\n"
    "‚Ä¢ –ù–µ —Ö–æ—á–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å ‚Äî –ø—å—ë—à—å –≥–ª–æ—Ç–æ–∫ ‚òï/üç∑\n"
    "‚Ä¢ –í—Å—ë —Å–∫–∞–∑–∞–Ω–Ω–æ–µ –æ—Å—Ç–∞—ë—Ç—Å—è –º–µ–∂–¥—É –Ω–∞–º–∏ üòâ"
)

# ======================
# –°–û–°–¢–û–Ø–ù–ò–ï
# ======================

@dataclass
class GameState:
    mode: str
    cards: List[str]

GAMES: Dict[int, GameState] = {}

# ======================
# –ö–ù–û–ü–ö–ò
# ======================

def start_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("‚òï –ü–æ–¥ –∫–æ—Ñ–µ", callback_data="mode_coffee")],
        [InlineKeyboardButton("üç∑ –ú–æ—è –±–µ—Å—Ç–∏—è", callback_data="mode_wine")]
    ])

def next_card_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üé¥ –°–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–∞", callback_data="next")],
        [InlineKeyboardButton("üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ", callback_data="restart")]
    ])

# ======================
# –•–≠–ù–î–õ–ï–†–´
# ======================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        RULES_TEXT,
        parse_mode="Markdown",
        reply_markup=start_keyboard()
    )

async def choose_mode(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    chat_id = query.message.chat_id

    if query.data == "mode_coffee":
        cards = COFFEE_CARDS.copy()
        mode = "‚òï –ü–æ–¥ –∫–æ—Ñ–µ"
    else:
        cards = WINE_CARDS.copy()
        mode = "üç∑ –ú–æ—è –±–µ—Å—Ç–∏—è"

    random.shuffle(cards)
    GAMES[chat_id] = GameState(mode=mode, cards=cards)

    await query.edit_message_text(
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏ —Ä–µ–∂–∏–º *{mode}*\n\n–ì–æ—Ç–æ–≤—ã –∏–≥—Ä–∞—Ç—å?",
        parse_mode="Markdown",
        reply_markup=next_card_keyboard()
    )

async def next_card(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    chat_id = query.message.chat_id
    game = GAMES.get(chat_id)

    if not game or not game.cards:
        await query.edit_message_text(
            "–ö–∞—Ä—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å üòÑ\n–•–æ—Ç–∏—Ç–µ —Å—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑?",
            reply_markup=start_keyboard()
        )
        return

    card = game.cards.pop()
    await query.edit_message_text(
        f"üé¥ *–ö–∞—Ä—Ç–∞:*\n\n{card}",
        parse_mode="Markdown",
        reply_markup=next_card_keyboard()
    )

async def restart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    await query.edit_message_text(
        RULES_TEXT,
        parse_mode="Markdown",
        reply_markup=start_keyboard()
    )

# ======================
# –ó–ê–ü–£–°–ö
# ======================

def main():
    token = os.getenv("BOT_TOKEN")
    app = Application.builder().token(token).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(choose_mode, pattern="mode_"))
    app.add_handler(CallbackQueryHandler(next_card, pattern="next"))
    app.add_handler(CallbackQueryHandler(restart, pattern="restart"))

    app.run_polling()

if __name__ == "__main__":
    main()
