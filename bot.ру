import os
import random
from dataclasses import dataclass, field
from typing import Dict, List

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
)

# ======================
# –†–ï–ñ–ò–ú–´
# ======================

MODE_BESTIA = "bestia"
MODE_COFFEE = "coffee"

# ======================
# –í–û–ü–†–û–°–´
# ======================

QUESTIONS = {
    MODE_BESTIA: [
        "–¢—ã —á–∞—â–µ –ø—Ä–∏—Ç–≤–æ—Ä—è–µ—à—å—Å—è –º–∏–ª–æ–π –∏–ª–∏ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—à—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä?",
        "–¢—ã –∏–∑ —Ç–µ—Ö, –∫—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç ¬´–º–Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ¬ª, –Ω–æ –Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ?",
        "–¢—ã –ª—é–±–∏—à—å –±—ã—Ç—å –ø—Ä–∞–≤–æ–π –∏–ª–∏ —á—Ç–æ–±—ã –≤—Å–µ –ø–æ–Ω—è–ª–∏, —á—Ç–æ —Ç—ã –±—ã–ª–∞ –ø—Ä–∞–≤–∞?",
        "–¢—ã –±—ã—Å—Ç—Ä–µ–µ –∑–∞–≤–æ–¥–∏—à—å—Å—è –∏–ª–∏ –±—ã—Å—Ç—Ä–µ–µ –æ—Å—Ç—ã–≤–∞–µ—à—å?",
        "–¢—ã —É–º–µ–µ—à—å —Å–∫—Ä—ã–≤–∞—Ç—å —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ?",
        "–¢—ã —á–∞—â–µ –¥–µ–π—Å—Ç–≤—É–µ—à—å –Ω–∞ —ç–º–æ—Ü–∏—è—Ö –∏–ª–∏ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–µ?",
        "–¢—ã –∏–∑ —Ç–µ—Ö, –∫—Ç–æ –≤—Å—ë –∑–∞–º–µ—á–∞–µ—Ç, –Ω–æ –º–æ–ª—á–∏—Ç?",
        "–¢—ã –ª—é–±–∏—à—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é?",
        "–¢—ã –º–æ–∂–µ—à—å —Ä–µ–∑–∫–æ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?",
        "–¢—ã —á–∞—â–µ —Å–º–µ—ë—à—å—Å—è –∏–ª–∏ –∑–∞–∫–∞—Ç—ã–≤–∞–µ—à—å –≥–ª–∞–∑–∞?",

        "–¢—ã –∏–∑ —Ç–µ—Ö, –∫—Ç–æ –º–æ–∂–µ—Ç –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –æ–¥–Ω–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º?",
        "–¢—ã –ª–µ–≥–∫–æ –≤—ã—Ö–æ–¥–∏—à—å –∏–∑ —Å–µ–±—è?",
        "–¢—ã —á–∞—â–µ –ø—Ä–æ–≤–µ—Ä—è–µ—à—å –ª—é–¥–µ–π –∏–ª–∏ –¥–æ–≤–µ—Ä—è–µ—à—å —Å—Ä–∞–∑—É?",
        "–¢—ã –ª—é–±–∏—à—å –±—ã—Ç—å –≤ —Ü–µ–Ω—Ç—Ä–µ –≤–Ω–∏–º–∞–Ω–∏—è?",
        "–¢—ã –º–æ–∂–µ—à—å –±—ã—Ç—å —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ–π?",
        "–¢—ã –∏–∑ —Ç–µ—Ö, –∫—Ç–æ –¥–æ–ª–≥–æ –ø–æ–º–Ω–∏—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã?",
        "–¢—ã —á–∞—â–µ –≥–æ–≤–æ—Ä–∏—à—å –ø—Ä—è–º–æ –∏–ª–∏ –Ω–∞–º—ë–∫–∞–º–∏?",
        "–¢—ã —É–º–µ–µ—à—å –¥–µ—Ä–∂–∞—Ç—å –ø–∞—É–∑—É?",
        "–¢—ã –±–æ–ª—å—à–µ –∑–∞ —Ö–∞–æ—Å –∏–ª–∏ –∑–∞ –ø–æ—Ä—è–¥–æ–∫?",
        "–¢—ã –ª—é–±–∏—à—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç–∏?",

        "–¢—ã –∏–∑ —Ç–µ—Ö, –∫—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–µ—Ç, –ø–æ—Ç–æ–º –¥—É–º–∞–µ—Ç?",
        "–¢—ã —á–∞—Å—Ç–æ –ø–µ—Ä–µ–∏–≥—Ä—ã–≤–∞–µ—à—å —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –≤ –≥–æ–ª–æ–≤–µ?",
        "–¢—ã —É–º–µ–µ—à—å –≤–æ–≤—Ä–µ–º—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è?",
        "–¢—ã –ª—é–±–∏—à—å –æ—Å—Ç—Ä—ã–µ —à—É—Ç–∫–∏?",
        "–¢—ã –ª–µ–≥–∫–æ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—à—å—Å—è –Ω–∞ –º–µ–ª–æ—á–∏?",
        "–¢—ã –º–æ–∂–µ—à—å –±—ã—Ç—å —Ä–µ–∑–∫–æ–π, –µ—Å–ª–∏ —É—Å—Ç–∞–ª–∞?",
        "–¢—ã —á–∞—â–µ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—à—å—Å—è –∏–ª–∏ –Ω–∞—Å—Ç–∞–∏–≤–∞–µ—à—å?",
        "–¢—ã –∏–∑ —Ç–µ—Ö, –∫—Ç–æ —Å—Ä–∞–∑—É —á—É–≤—Å—Ç–≤—É–µ—Ç —Ñ–∞–ª—å—à—å?",
        "–¢—ã –ª—é–±–∏—à—å, –∫–æ–≥–¥–∞ –≤—Å—ë –∏–¥—ë—Ç –ø–æ —Ç–≤–æ–µ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é?",
        "–¢—ã —É–º–µ–µ—à—å –¥–µ–ª–∞—Ç—å –≤–∏–¥, —á—Ç–æ –≤—Å—ë –Ω–æ—Ä–º–∞–ª—å–Ω–æ?",

        "–¢—ã –∏–∑ —Ç–µ—Ö, –∫—Ç–æ –º–æ–∂–µ—Ç –≤–Ω–µ–∑–∞–ø–Ω–æ –∑–∞–º–æ–ª—á–∞—Ç—å?",
        "–¢—ã –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—à—å—Å—è –∫ –ª—é–¥—è–º?",
        "–¢—ã —á–∞—â–µ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è –∏–ª–∏ —É–≤–µ—Ä–µ–Ω–∞ –≤ —Å–µ–±–µ?",
        "–¢—ã –ª—é–±–∏—à—å —Å–ø–æ—Ä—ã?",
        "–¢—ã —É–º–µ–µ—à—å –±—ã—Ç—å –º—è–≥–∫–æ–π, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å?",
        "–¢—ã —á–∞—â–µ –∑–∞—â–∏—â–∞–µ—à—å—Å—è –∏–ª–∏ –Ω–∞–ø–∞–¥–∞–µ—à—å?",
        "–¢—ã –º–æ–∂–µ—à—å –±—ã—Ç—å —Ö–æ–ª–æ–¥–Ω–æ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ?",
        "–¢—ã –∏–∑ —Ç–µ—Ö, –∫—Ç–æ –ª–µ–≥–∫–æ –∑–∞–∂–∏–≥–∞–µ—Ç –∫–æ–º–ø–∞–Ω–∏—é?",
        "–¢—ã —É–º–µ–µ—à—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è?",
        "–° —Ç–æ–±–æ–π —Å–∫–æ—Ä–µ–µ –ª–µ–≥–∫–æ –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ?"
    ],

    MODE_COFFEE: [
        "–ö—Ç–æ –∏–∑ –≤–∞—Å –≤—ã–≥–ª—è–¥–∏—Ç —Å–∞–º–æ–π —Å–ø–æ–∫–æ–π–Ω–æ–π, –Ω–æ —è–≤–Ω–æ –Ω–µ —Ç–∞–∫–∞—è?",
        "–ö—Ç–æ –¥–æ–ª—å—à–µ –≤—Å–µ—Ö —Å–µ–≥–æ–¥–Ω—è –≤—ã–±–∏—Ä–∞–ª, —á—Ç–æ –Ω–∞–¥–µ—Ç—å?",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫, –±—É–¥—Ç–æ –∑–Ω–∞–µ—Ç –≤—Å–µ —Å–ø–ª–µ—Ç–Ω–∏?",
        "–ö—Ç–æ —Å–µ–π—á–∞—Å –¥—É–º–∞–µ—Ç: ¬´—á—Ç–æ —è –≤–æ–æ–±—â–µ –∑–¥–µ—Å—å –¥–µ–ª–∞—é?¬ª",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Å–∞–º–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ–π?",
        "–ö—Ç–æ —è–≤–Ω–æ –ø—Ä–∏—à—ë–ª –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π –∑–∞–≥–∞–¥–æ—á–Ω–æ–π?",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫, –±—É–¥—Ç–æ –±—ã—Å—Ç—Ä–æ —Å–æ –≤—Å–µ–º–∏ –ø–æ–¥—Ä—É–∂–∏—Ç—Å—è?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π —Å–µ—Ä—å—ë–∑–Ω–æ–π ‚Äî –∏ —ç—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ?",
        "–ö—Ç–æ —Å—Ä–∞–∑—É —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è –∫–∞–∫ –¥–æ–º–∞?",

        "–ö–æ–º—É –±—ã —Ç—ã –ø–µ—Ä–≤–æ–π –Ω–∞–ø–∏—Å–∞–ª–∞ –ø–æ—Å–ª–µ —ç—Ç–æ–π –≤—Å—Ç—Ä–µ—á–∏?",
        "–° –∫–µ–º –±—ã —Ç—ã –ø–æ—à–ª–∞ –Ω–∞ –∫–æ—Ñ–µ —Ç–µ—Ç-–∞-—Ç–µ—Ç?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π –±–æ–ª—Ç–ª–∏–≤–æ–π?",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫, –±—É–¥—Ç–æ —É–º–µ–µ—Ç —Å–ª—É—à–∞—Ç—å?",
        "–° –∫–µ–º —Ç–æ—á–Ω–æ –Ω–µ –±—É–¥–µ—Ç –Ω–µ–ª–æ–≤–∫–æ –º–æ–ª—á–∞—Ç—å?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π –ª—ë–≥–∫–æ–π –≤ –æ–±—â–µ–Ω–∏–∏?",
        "–° –∫–µ–º –±—ã —Ç—ã —Å–µ–ª–∞ —Ä—è–¥–æ–º –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑?",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫, –±—É–¥—Ç–æ —É –Ω–µ—ë –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π?",
        "–° –∫–µ–º –±—ã —Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∏–ª–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä?",

        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫, –±—É–¥—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å—Ç—Ä–∞–Ω–Ω—É—é –∏–¥–µ—é?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–π?",
        "–ö—Ç–æ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å —Å–º–µ—è—Ç—å—Å—è –≤ —Å–∞–º—ã–π –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π –º–æ–º–µ–Ω—Ç?",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ ¬´–∞ –ø–æ–µ—Ö–∞–ª–∏¬ª?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–π?",
        "–ö—Ç–æ –º–æ–∂–µ—Ç –≤–Ω–µ–∑–∞–ø–Ω–æ —Ä–∞—Å—à–µ–≤–µ–ª–∏—Ç—å –≤—Å–µ—Ö?",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫, –±—É–¥—Ç–æ –ª—é–±–∏—Ç –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è?",
        "–ö—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–µ—á–µ—Ä?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π?",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ ¬´–¥–∞–≤–∞–π—Ç–µ –µ—â—ë –ø–æ—Å–∏–¥–∏–º¬ª?",

        "–° –∫–µ–º —Ç–µ–±–µ —É–∂–µ —Å–µ–π—á–∞—Å –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π –∏—Å–∫—Ä–µ–Ω–Ω–µ–π?",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫, –±—É–¥—Ç–æ –ª–µ–≥–∫–æ —Å–±–ª–∏–∂–∞–µ—Ç—Å—è —Å –ª—é–¥—å–º–∏?",
        "–ö—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –æ—â—É—â–µ–Ω–∏–µ —É—é—Ç–∞?",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π –æ—Ç–∫—Ä—ã—Ç–æ–π?",
        "–ö—Ç–æ —É–º–µ–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä?",
        "–ö—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ ¬´—Å –Ω–µ–π –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –±—ã—Ç—å¬ª?",
        "–ö—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–∏—è—Ç–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É?",
        "–° –∫–µ–º —Ö–æ—á–µ—Ç—Å—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—â–µ–Ω–∏–µ?",

        "–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–∏—è—Ç–Ω–æ —É–¥–∏–≤–∏–ª?",
        "–ö–æ–≥–æ –±—ã —Ç—ã —Ö–æ—Ç–µ–ª–∞ —É–∑–Ω–∞—Ç—å –ø–æ–±–ª–∏–∂–µ?",
        "–ö—Ç–æ –æ–∫–∞–∑–∞–ª—Å—è –Ω–µ —Ç–∞–∫–∏–º, –∫–∞–∫ —Ç—ã –æ–∂–∏–¥–∞–ª–∞?",
        "–ö—Ç–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∑–∞–ø–æ–º–Ω–∏–ª—Å—è?",
        "–° –∫–µ–º –±—ã —Ç—ã —Ç–æ—á–Ω–æ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∞—Å—å –µ—â—ë —Ä–∞–∑?",
        "–ö—Ç–æ –∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π ¬´—Å–≤–æ–µ–π¬ª?",
        "–ö—Ç–æ —Å–¥–µ–ª–∞–ª —ç—Ç—É –≤—Å—Ç—Ä–µ—á—É —Ç–µ–ø–ª–µ–µ?",
        "–ö–æ–≥–æ –±—ã —Ç—ã –ø–æ–∑–≤–∞–ª–∞ –≤ —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–ø–∞–Ω–∏—é?",
        "–° –∫–µ–º –±—ã —Ç—ã –≤—ã–ø–∏–ª–∞ –µ—â—ë –∫–æ—Ñ–µ?",
        "–ö—Ç–æ —Å–¥–µ–ª–∞–ª —ç—Ç—É –∏–≥—Ä—É –∫–ª–∞—Å—Å–Ω–æ–π?"
    ]
}

# ======================
# –°–û–°–¢–û–Ø–ù–ò–ï
# ======================

@dataclass
class Game:
    chat_id: int
    mode: str = ""
    players: List[int] = field(default_factory=list)
    names: Dict[int, str] = field(default_factory=dict)
    current_player: int = 0
    question_index: int = 0

GAMES: Dict[int, Game] = {}

# ======================
# –ö–ù–û–ü–ö–ò
# ======================

def mode_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üç∑ –ú–û–Ø –ë–ï–°–¢–ò–Ø", callback_data="mode_bestia")],
        [InlineKeyboardButton("‚òï –ú–ï–ñ–î–£ –ù–ê–ú–ò, –î–ï–í–û–ß–ö–ê–ú–ò", callback_data="mode_coffee")]
    ])

def join_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üôã‚Äç‚ôÄÔ∏è –Ø –í –ò–ì–†–ï", callback_data="join")]
    ])

def next_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üëâ –î–ê–õ–¨–®–ï", callback_data="next")]
    ])

# ======================
# –ö–û–ú–ê–ù–î–´
# ======================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üíñ –ò–≥—Ä–∞ –¥–ª—è –¥–µ–≤–∏—á–Ω–∏–∫–æ–≤\n\n"
        "/newgame ‚Äî –Ω–æ–≤–∞—è –∏–≥—Ä–∞\n"
        "/startgame ‚Äî –Ω–∞—á–∞—Ç—å"
    )

async def newgame(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    GAMES[chat_id] = Game(chat_id=chat_id)
    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º üëá", reply_markup=mode_keyboard())

async def startgame(update: Update, context: ContextTypes.DEFAULT_TYPE):
    game = GAMES.get(update.effective_chat.id)
    if not game or len(game.players) < 2:
        await update.message.reply_text("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞")
        return
    random.shuffle(game.players)
    await send_question(context, game)

# ======================
# CALLBACK
# ======================

async def on_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    game = GAMES.get(query.message.chat_id)
    if not game:
        return

    if query.data.startswith("mode_"):
        game.mode = MODE_BESTIA if query.data == "mode_bestia" else MODE_COFFEE
        await query.edit_message_text(
            "–ù–∞–∂–º–∏—Ç–µ ¬´–Ø –≤ –∏–≥—Ä–µ¬ª üëá",
            reply_markup=join_keyboard()
        )
        return

    if query.data == "join":
        user = query.from_user
        if user.id not in game.players:
            game.players.append(user.id)
            game.names[user.id] = user.first_name
        await query.edit_message_text(
            f"–í –∏–≥—Ä–µ: {', '.join(game.names.values())}\n\n/startgame ‚Äî –Ω–∞—á–∞—Ç—å"
        )
        return

    if query.data == "next":
        await send_question(context, game)

# ======================
# –ò–ì–†–ê
# ======================

async def send_question(context, game: Game):
    if game.question_index >= len(QUESTIONS[game.mode]):
        await context.bot.send_message(game.chat_id, "üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!")
        GAMES.pop(game.chat_id, None)
        return

    pid = game.players[game.current_player]
    name = game.names[pid]
    question = QUESTIONS[game.mode][game.question_index]

    await context.bot.send_message(
        game.chat_id,
        f"üéØ –•–æ–¥: {name}\n\n{question}",
        reply_markup=next_keyboard()
    )

    game.current_player = (game.current_player + 1) % len(game.players)
    game.question_index += 1

# ======================
# –ó–ê–ü–£–°–ö
# ======================

def main():
    token = os.getenv("BOT_TOKEN")
    app = Application.builder().token(token).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("newgame", newgame))
    app.add_handler(CommandHandler("startgame", startgame))
    app.add_handler(CallbackQueryHandler(on_callback))
    app.run_polling()

if __name__ == "__main__":
    main()

