import os
import logging
import random
from dataclasses import dataclass, field
from typing import Dict, List, Optional, Tuple

from aiogram import Bot, Dispatcher, types
from aiogram.utils import executor
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

# =======================
# –ù–ê–°–¢–†–û–ô–ö–ò
# =======================

logging.basicConfig(level=logging.INFO)

BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN is missing")

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

MODE_WINE = "wine"
MODE_COFFEE = "coffee"

# =======================
# –í–û–ü–†–û–°–´ ‚Äî –í–ò–ù–û (–¢–í–û–ò, –ù–ï –ú–ï–ù–Ø–Æ)
# =======================

QUESTIONS_WINE = [
    {"q": "–¢—ã –ø–∏—à–µ—à—å ¬´–æ–∫¬ª ‚Äî —ç—Ç–æ‚Ä¶"},
    {"q": "–ï—Å–ª–∏ —è –æ–ø–∞–∑–¥—ã–≤–∞—é –Ω–∞ 20 –º–∏–Ω—É—Ç, —Ç—ã‚Ä¶"},
    {"q": "–í –ø–ª–æ—Ö–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–Ω–µ –ª—É—á—à–µ –ø—Ä–∏—Å–ª–∞—Ç—å‚Ä¶"},
    {"q": "–ú—ã –º–æ–∂–µ–º –Ω–µ –æ–±—â–∞—Ç—å—Å—è –º–µ—Å—è—Ü –∏ –Ω–µ –æ–±–∏–∂–∞—Ç—å—Å—è?"},
    {"q": "–ï—Å–ª–∏ –º—ã –ø–æ—Å—Å–æ—Ä–∏–ª–∏—Å—å ‚Äî –∫—Ç–æ –ø–µ—Ä–≤—ã–π –ø—Ä–∏—à–ª—ë—Ç –º–µ–º?"},
    {"q": "–ö–∞–∫—É—é —Å–∞–º—É—é —Å—Ç—Ä–∞–Ω–Ω—É—é –ø—Ä–∏–≤—ã—á–∫—É —É –º–µ–Ω—è –∑–Ω–∞–µ—à—å?"},
    {"q": "–ï—Å–ª–∏ –º—ã –∏–¥—ë–º –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫—É –≤–º–µ—Å—Ç–µ, –∫—Ç–æ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º?"},
    {"q": "–ö—Ç–æ –∏–∑ –Ω–∞—Å –±–æ–ª—å—à–µ –ª—é–±–∏—Ç –∫–æ—Ñ–µ?"},
    {"q": "–ï—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–∞—á–Ω—ë—Ç—Å—è —Ç–∞–Ω—Ü–µ–≤–∞–ª—å–Ω—ã–π –±–∞—Ç—Ç–ª, –∫—Ç–æ –≤—ã–∏–≥—Ä–∞–µ—Ç?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –∑–∞–±—ã–≤–∞–µ—Ç –∫–ª—é—á–∏?"},
    {"q": "–° –∫–µ–º –ª–µ–≥—á–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–µ–∫—Ä–µ—Ç–æ–º?"},
    {"q": "–ö—Ç–æ –≥—Ä–æ–º—á–µ —Å–º–µ—ë—Ç—Å—è?"},
    {"q": "–ï—Å–ª–∏ –±—ã –º—ã —Å—Ç–∞–ª–∏ —Å—É–ø–µ—Ä–≥–µ—Ä–æ—è–º–∏, –∫—Ç–æ –±—ã –±—ã–ª‚Ä¶"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–ø–æ—Ä—ã?"},
    {"q": "–ö—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –µ—Å—Ç —Å–ª–∞–¥–∫–æ–µ?"},
    {"q": "–ö—Ç–æ –ª—É—á—à–µ –≥–æ—Ç–æ–≤–∏—Ç –º–µ–º—ã?"},
    {"q": "–ï—Å–ª–∏ —è –ø–ª–∞—á—É –Ω–∞–¥ —Å–µ—Ä–∏–∞–ª–æ–º, –∫—Ç–æ –º–µ–Ω—è –ø–æ–π–º—ë—Ç?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ —Å—Ç–∞–≤–∏—Ç –ª–∞–π–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–∏—Å?"},
    {"q": "–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –∫—Ç–æ –±—ã—Å—Ç—Ä–µ–µ —Å–¥–∞—ë—Ç—Å—è?"},
    {"q": "–ö—Ç–æ –∏–∑ –Ω–∞—Å –±–æ–ª—å—à–µ –ª—é–±–∏—Ç –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è?"},
    {"q": "–ö—Ç–æ –ª—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç —Å–µ–∫—Ä–µ—Ç—ã?"},
    {"q": "–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ —Å–∫—É—á–∞–µ—Ç, –∫—Ç–æ –ø–µ—Ä–≤—ã–º –Ω–∞–ø–∏—à–µ—Ç?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –¥–µ–ª–∞–µ—Ç —Å–º–µ—à–Ω—ã–µ —Å–µ–ª—Ñ–∏?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ —Å–ø–æ—Ä–∏—Ç –æ —Ñ–∏–ª—å–º–∞—Ö?"},
    {"q": "–ö—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –±–µ—Ä—ë—Ç –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É?"},
    {"q": "–ï—Å–ª–∏ —è –≥—Ä—É—â—É, –∫—Ç–æ –º–µ–Ω—è —Ä–∞–∑–≤–µ—Å–µ–ª–∏—Ç?"},
    {"q": "–ö—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞—á–∏–Ω–∞–µ—Ç —à—É—Ç–∏—Ç—å?"},
    {"q": "–ï—Å–ª–∏ –∏–¥—ë–º –≤ –º–∞–≥–∞–∑–∏–Ω, –∫—Ç–æ –±–æ–ª—å—à–µ –ø–æ–∫—É–ø–∞–µ—Ç?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç –≤—Å—Ç—Ä–µ—á–∏?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –æ–ø–∞–∑–¥—ã–≤–∞–µ—Ç –Ω–∞ –≤—Å—Ç—Ä–µ—á–∏?"},
    {"q": "–ö—Ç–æ —Å–º–µ—à–Ω–µ–µ —à—É—Ç–∏—Ç?"},
    {"q": "–ö—Ç–æ –ª—É—á—à–µ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∏–º–µ–Ω–∞?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∏–¥–µ–∏?"},
    {"q": "–ö—Ç–æ —Å–∏–ª—å–Ω–µ–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏—Ö?"},
    {"q": "–ö—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞—Ö–æ–¥–∏—Ç –º–µ–º—ã?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –¥–µ–ª–∞–µ—Ç –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã?"},
    {"q": "–ö—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –æ—Å–≤–∞–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ —à—É—Ç–∏—Ç –ø—Ä–æ –µ–¥—É?"},
    {"q": "–ö—Ç–æ –≥—Ä–æ–º—á–µ —Å–º–µ—ë—Ç—Å—è –Ω–∞–¥ –º–µ–º–∞–º–∏?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ —Ç–µ—Ä—è–µ—Ç –≤–µ—â–∏?"},
    {"q": "–ö—Ç–æ –∏–∑ –Ω–∞—Å –±–æ–ª—å—à–µ —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã–π?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –ø–∏—à–µ—Ç –ø–µ—Å–Ω–∏, —Å—Ç–∏—Ö–∏ –∏–ª–∏ —à—É—Ç–∫–∏?"},
    {"q": "–ö—Ç–æ –±—ã—Å—Ç—Ä–µ–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –Ω–æ–≤–æ—Å—Ç–∏?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –¥–µ–ª–∞–µ—Ç –Ω–µ–æ–±—ã—á–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏?"},
    {"q": "–ö—Ç–æ –ª—É—á—à–µ –≥–æ—Ç–æ–≤ –¥–µ–ª–∏—Ç—å—Å—è?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –∑–∞–±—ã–≤–∞–µ—Ç –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –±–µ—Ä—ë—Ç –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö?"},
    {"q": "–ö—Ç–æ –≥—Ä–æ–º—á–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –º–µ–º—ã?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ —à—É—Ç–∏—Ç –ø—Ä–æ —Ä–∞–±–æ—Ç—É?"},
    {"q": "–ö—Ç–æ –±–æ–ª—å—à–µ –ª—é–±–∏—Ç —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã–µ –≤–µ—á–µ—Ä–∏–Ω–∫–∏?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ –¥–µ–ª–∞–µ—Ç –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã –Ω–µ–∑–Ω–∞–∫–æ–º—Ü–∞–º?"},
    {"q": "–ö—Ç–æ –ª—É—á—à–µ –∑–Ω–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥—Ä—É–≥ –¥—Ä—É–≥–∞?"},
    {"q": "–ö—Ç–æ —á–∞—â–µ —Å–º–µ—ë—Ç—Å—è –Ω–∞–¥ —Å–æ–±–æ–π?"}
]

# =======================
# –í–û–ü–†–û–°–´ ‚Äî –ö–û–§–ï (–¢–í–û–ò, –ù–ï –ú–ï–ù–Ø–Æ)
# =======================

QUESTIONS_COFFEE = [
    {"q": "–ö–∞–∫–æ–µ —É —Ç–µ–±—è –±—ã–ª–æ —Å–∞–º–æ–µ –ª—é–±–∏–º–æ–µ –∑–∞–Ω—è—Ç–∏–µ –≤ –¥–µ—Ç—Å—Ç–≤–µ?"},
    {"q": "–ö–∞–∫–æ–π –º—É–ª—å—Ç—Ñ–∏–ª—å–º —Ç—ã –º–æ–≥–ª–∞ –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ?"},
    {"q": "–ß—Ç–æ —Ç—ã –≤—Å–µ–≥–¥–∞ –±—Ä–∞–ª–∞ —Å —Å–æ–±–æ–π –≤ —à–∫–æ–ª—É –∏–ª–∏ —Å–∞–¥–∏–∫, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –±—ã–ª–æ?"},
    {"q": "–ö–∞–∫–∞—è –µ–¥–∞ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç —Ç–µ–±—è –≤ –¥–µ—Ç—Å—Ç–≤–æ?"},
    {"q": "–ö–µ–º —Ç—ã –º–µ—á—Ç–∞–ª–∞ —Å—Ç–∞—Ç—å, –∫–æ–≥–¥–∞ –±—ã–ª–∞ –º–∞–ª–µ–Ω—å–∫–æ–π?"},
    {"q": "–ë—ã–ª–∞ –ª–∏ —É —Ç–µ–±—è –ª—é–±–∏–º–∞—è –∏–≥—Ä—É—à–∫–∞, –±–µ–∑ –∫–æ—Ç–æ—Ä–æ–π –Ω–µ–ª—å–∑—è –±—ã–ª–æ —É—Å–Ω—É—Ç—å?"},
    {"q": "–ö–∞–∫–æ–π –∑–∞–ø–∞—Ö —É —Ç–µ–±—è –∞—Å—Å–æ—Ü–∏–∏—Ä—É–µ—Ç—Å—è —Å –¥–æ–º–æ–º?"},
    {"q": "–ó–∞ —á—Ç–æ —Ç–µ–±—è —á–∞—â–µ –≤—Å–µ–≥–æ —Ö–≤–∞–ª–∏–ª–∏ –≤ –¥–µ—Ç—Å—Ç–≤–µ?"},
    {"q": "–ö–∞–∫—É—é —Å–∞–º—É—é —Å–º–µ—à–Ω—É—é –∫–ª–∏—á–∫—É —Ç–µ–±–µ –∫–æ–≥–¥–∞-–ª–∏–±–æ –¥–∞–≤–∞–ª–∏?"},
    {"q": "–ö–∞–∫–æ–π –º–æ–º–µ–Ω—Ç –∏–∑ –¥–µ—Ç—Å—Ç–≤–∞ –¥–æ —Å–∏—Ö –ø–æ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç —É–ª—ã–±–∫—É?"},
    {"q": "–ß—Ç–æ —Ç—ã –¥–µ–ª–∞–ª–∞, –∫–æ–≥–¥–∞ —Ö–æ—Ç–µ–ª–∞, —á—Ç–æ–±—ã —Ç–µ–±—è –æ—Å—Ç–∞–≤–∏–ª–∏ –≤ –ø–æ–∫–æ–µ?"},
    {"q": "–ö–∞–∫—É—é –µ—Ä—É–Ω–¥—É —Ç—ã –æ–±–æ–∂–∞–ª–∞, —Ö–æ—Ç—è –≤–∑—Ä–æ—Å–ª—ã–µ –Ω–µ –ø–æ–Ω–∏–º–∞–ª–∏ –ø–æ—á–µ–º—É?"},
    {"q": "–ö–∞–∫–æ–π –±—ã–ª —Ç–≤–æ–π —Å–∞–º—ã–π –ª—é–±–∏–º—ã–π –ø—Ä–∞–∑–¥–Ω–∏–∫ –≤ –¥–µ—Ç—Å—Ç–≤–µ?"},
    {"q": "–ï—Å–ª–∏ –±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å –≤ –¥–µ—Ç—Å—Ç–≤–æ ‚Äî –∫—É–¥–∞ –±—ã —Ç—ã –ø–æ—à–ª–∞?"},
    {"q": "–ö–∞–∫–æ–π —É —Ç–µ–±—è –±—ã–ª —Å–∞–º—ã–π —Å–º–µ—à–Ω–æ–π —Å—Ç—Ä–∞—Ö –≤ –¥–µ—Ç—Å—Ç–≤–µ?"},
    {"q": "–ß—Ç–æ —Ç—ã –¥–µ–ª–∞–ª–∞, –∫–æ–≥–¥–∞ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –æ–¥–Ω–∞ –¥–æ–º–∞?"},
    {"q": "–ö–∞–∫–æ–π —Å–∞–º—ã–π —Ç—ë–ø–ª—ã–π —Å–µ–º–µ–π–Ω—ã–π —Ä–∏—Ç—É–∞–ª —Ç—ã –ø–æ–º–Ω–∏—à—å?"},
    {"q": "–ß—Ç–æ —Ç—ã –æ–±–æ–∂–∞–ª–∞ –¥–µ–ª–∞—Ç—å, –∫–æ–≥–¥–∞ —à—ë–ª –¥–æ–∂–¥—å?"},
    {"q": "–ö–∞–∫—É—é –º–µ–ª–æ—á—å —Ç—ã –¥–æ —Å–∏—Ö –ø–æ—Ä —Ö—Ä–∞–Ω–∏—à—å ¬´–Ω–∞ –ø–∞–º—è—Ç—å¬ª?"},
    {"q": "–ö–∞–∫–æ–π –±—ã–ª —Ç–≤–æ–π –∫–æ—Ä–æ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–¥–Ω–∏–º–∞—Ç—å —Å–µ–±–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?"},
    {"q": "–ß—Ç–æ —Ç–µ–±—è –≤—Å–µ–≥–¥–∞ —Å–º–µ—à–∏–ª–æ, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –Ω–µ–ª—å–∑—è –±—ã–ª–æ —Å–º–µ—è—Ç—å—Å—è?"},
    {"q": "–ö–∞–∫–æ–π –º–æ–º–µ–Ω—Ç —Ç—ã –±—ã —Ö–æ—Ç–µ–ª–∞ –ø–µ—Ä–µ–∂–∏—Ç—å –µ—â—ë —Ä–∞–∑?"},
    {"q": "–ß—Ç–æ —Ç—ã –¥–µ–ª–∞–ª–∞, —á—Ç–æ–±—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è —Å–º–µ–ª–æ–π?"},
    {"q": "–ö–∞–∫–æ–π –±—ã–ª —Ç–≤–æ–π —Å–∞–º—ã–π —É—é—Ç–Ω—ã–π —É–≥–æ–ª–æ–∫?"},
    {"q": "–ö–∞–∫–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ –∏–∑ –¥–µ—Ç—Å—Ç–≤–∞ –æ—Å—Ç–∞–ª–∞—Å—å —Å —Ç–æ–±–æ–π –¥–æ —Å–∏—Ö –ø–æ—Ä?"},
    {"q": "–ö–∞–∫–æ–π –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç —Ç—ã –∑–∞–ø–æ–º–Ω–∏–ª–∞ –Ω–∞ –≤—Å—é –∂–∏–∑–Ω—å?"},
    {"q": "–ß—Ç–æ —Ç—ã —Å—á–∏—Ç–∞–ª–∞ –Ω–∞—Å—Ç–æ—è—â–∏–º —Å—á–∞—Å—Ç—å–µ–º, –∫–æ–≥–¥–∞ –±—ã–ª–∞ –º–∞–ª–µ–Ω—å–∫–æ–π?"},
    {"q": "–ö–∞–∫–æ–π –¥–µ–Ω—å –∏–∑ –¥–µ—Ç—Å—Ç–≤–∞ —Ç—ã –ø–æ–º–Ω–∏—à—å –æ—Å–æ–±–µ–Ω–Ω–æ —á—ë—Ç–∫–æ?"},
    {"q": "–ß—Ç–æ —Ç–µ–±—è –≤—Å–µ–≥–¥–∞ —É—Å–ø–æ–∫–∞–∏–≤–∞–ª–æ?"},
    {"q": "–ö–∞–∫–æ–π –ø—Ä–æ—Å—Ç–æ–π –º–æ–º–µ–Ω—Ç —Ç–æ–≥–¥–∞ –∫–∞–∑–∞–ª—Å—è –≤–æ–ª—à–µ–±–Ω—ã–º?"},
    {"q": "–ß—Ç–æ —Ç—ã –ª—é–±–∏–ª–∞ –¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–Ω–æ–º?"},
    {"q": "–ö–∞–∫—É—é —Å–º–µ—à–Ω—É—é —Ç—Ä–∞–¥–∏—Ü–∏—é —Ç—ã –ø—Ä–∏–¥—É–º–∞–ª–∞ —Å–∞–º–∞?"},
    {"q": "–ß—Ç–æ –¥–µ–ª–∞–ª–æ —Ç–≤–æ–π –¥–µ–Ω—å —Å—Ä–∞–∑—É —Ö–æ—Ä–æ—à–∏–º?"},
    {"q": "–ö–∞–∫–∞—è –º–µ–ª–æ—á—å –º–æ–≥–ª–∞ —Å–¥–µ–ª–∞—Ç—å —Ç–µ–±—è –±–µ–∑—É–º–Ω–æ —Å—á–∞—Å—Ç–ª–∏–≤–æ–π?"},
    {"q": "–ö–∞–∫–æ–π –∑–≤—É–∫ –∏–ª–∏ —Ñ—Ä–∞–∑–∞ —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –¥–µ—Ç—Å—Ç–≤–æ?"},
    {"q": "–ß—Ç–æ —Ç—ã –¥–µ–ª–∞–ª–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ –±—ã–ª–æ –ø—Ä–∏—è—Ç–Ω–æ?"},
    {"q": "–ö–∞–∫–æ–π –º–æ–º–µ–Ω—Ç –∏–∑ –¥–µ—Ç—Å—Ç–≤–∞ —Ç—ã —Ä–µ–¥–∫–æ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å, –Ω–æ –ª—é–±–∏—à—å –≤—Å–ø–æ–º–∏–Ω–∞—Ç—å?"},
    {"q": "–ß—Ç–æ —Ç—ã —Ö–æ—Ç–µ–ª–∞ –±—ã —Å–∫–∞–∑–∞—Ç—å —Å–µ–±–µ –º–∞–ª–µ–Ω—å–∫–æ–π —Å–µ–π—á–∞—Å?"},
    {"q": "–ö–∞–∫–æ–π —Ç—ã –±—ã–ª–∞, –∫–æ–≥–¥–∞ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ —Å–µ–±—è —Å–∞–º–æ–π —Å–æ–±–æ–π?"}
]

# =======================
# –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò (–¢–í–û–ò, –ù–ï –ú–ï–ù–Ø–Æ)
# =======================

COMMENTS_COFFEE = [
    "‚òï –ü–æ–¥ –∫–æ—Ñ–µ —ç—Ç–æ –∑–≤—É—á–∏—Ç –æ—Å–æ–±–µ–Ω–Ω–æ —á–µ—Å—Ç–Ω–æ",
    "‚òï –¢—É—Ç —è–≤–Ω–æ –±—ã–ª–æ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤",
    "‚òï –ö–∞–∂–µ—Ç—Å—è, —É –∫–æ–≥–æ-—Ç–æ –∏–Ω—Å–∞–π—Ç"
]

COMMENTS_WINE = [
    "üç∑ –ü–æ–¥ –±–æ–∫–∞–ª –≤–∏–Ω–∞ —Ç–∞–∫–∏–µ –æ—Ç–≤–µ—Ç—ã —Å–º–µ–ª–µ–µ",
    "üç∑ –≠—Ç–æ —Ç–æ—á–Ω–æ —Å–∫–∞–∑–∞–Ω–æ –Ω–µ –Ω–∞ —Ç—Ä–µ–∑–≤—É—é –≥–æ–ª–æ–≤—É",
    "üç∑ –û–π, —Ç—É—Ç –ø–æ—à–ª–∞ –ø—Ä–∞–≤–¥–∞"
]

FUNNY_REPLIES = [
    "–•–∞-—Ö–∞, —ç—Ç–æ –∑–≤—É—á–∏—Ç –∫–∞–∫ ¬´—è –≤ –ø–æ—Ä—è–¥–∫–µ¬ª‚Ä¶ –Ω–æ –º—ã-—Ç–æ –∑–Ω–∞–µ–º –ø—Ä–∞–≤–¥—É üòÑ",
    "–ó–∞–ø–∏—Å—ã–≤–∞—é –≤ –∑–æ–ª–æ—Ç–æ–π —Ñ–æ–Ω–¥ –∂–µ–Ω—Å–∫–æ–π –º—É–¥—Ä–æ—Å—Ç–∏ ‚úçÔ∏èüòå",
    "–û–π, –Ω—É –≤—Å—ë, —Ç–µ–ø–µ—Ä—å —è —Ñ–∞–Ω–∞—Ç —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ —Ç–µ–±—è üòÇ",
    "–≠—Ç–æ –±—ã–ª–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ‚Ä¶ –∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ üòÖ",
    "–¢–∞–∫, –≥–¥–µ –∫–Ω–æ–ø–∫–∞ ¬´–ø–æ–≤—Ç–æ—Ä–∏—Ç—å –µ—â—ë —Ä–∞–∑¬ª, —è –Ω–µ —É—Å–ø–µ–ª–∞ –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è üòÑ",
    "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ: —ç—Ç–æ –æ—Ç–≤–µ—Ç –¥–Ω—è üèÜ",
    "–ú–Ω–µ –∫–∞–∂–µ—Ç—Å—è, –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤—ã –¥–æ–ª–∂–Ω—ã –≤—ã–¥–∞—Ç—å —Å–µ–±–µ –º–µ–¥–∞–ª—å üòå",
    "–ù—É –≤—Å—ë, —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –Ω–∞—à–∞ –æ–±—â–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —à—É—Ç–∫–∞ ü§ùüòÇ"
]

FINAL_WINE = "üç∑ –§–∏–Ω–∞–ª! –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–µ—á–µ—Ä ü•Ç"
FINAL_COFFEE = "‚òï –§–∏–Ω–∞–ª! –°–ø–∞—Å–∏–±–æ –∑–∞ —É—é—Ç üíõ"

INSTRUCTION_TEXT = (
    "‚òïüç∑ –ò–ì–†–ê –î–õ–Ø –†–ê–ó–ì–û–í–û–†–û–í –ò –°–ú–ï–•–ê\n\n"
    "–≠—Ç–æ –Ω–µ —Ç–µ—Å—Ç –∏ –Ω–µ –∞–Ω–∫–µ—Ç–∞.\n"
    "–≠—Ç–æ –ø–æ–≤–æ–¥ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å, –ø–æ—Å–º–µ—è—Ç—å—Å—è –∏ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.\n\n"
    "–ö–∞–∫ –∏–≥—Ä–∞–µ–º:\n"
    "‚Äî –±–æ—Ç –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å\n"
    "‚Äî –≤—Å–µ –æ—Ç–≤–µ—á–∞—é—Ç –≤ —á–∞—Ç–µ (–∫–æ—Ä–æ—Ç–∫–æ –∏–ª–∏ –∫–∞–∫ —Ö–æ—á–µ—Ç—Å—è)\n"
    "‚Äî –º–æ–∂–Ω–æ –æ–±—Å—É–∂–¥–∞—Ç—å –∏ –¥–æ–ø–æ–ª–Ω—è—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞\n"
    "‚Äî –∫–æ–≥–¥–∞ –≤—Å–µ –≥–æ—Ç–æ–≤—ã ‚Äî –≤–µ–¥—É—â–∏–π –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–î–ê–õ–¨–®–ï¬ª\n\n"
    "–í–∞–∂–Ω–æ:\n"
    "‚Äî –Ω–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤\n"
    "‚Äî –∏–Ω–æ–≥–¥–∞ –±–æ—Ç –±—É–¥–µ—Ç —Å–º–µ—à–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã\n"
    "‚Äî —Å–∞–º—ã–µ —Å–º–µ—à–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å\n\n"
    "–ò–≥—Ä–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—Ñ–ª–∞–π–Ω –∏ –æ–Ω–ª–∞–π–Ω.\n"
    "–ï—Å–ª–∏ —Å—Ç–∞–ª–æ —Ç–µ–ø–ª–æ, —Å–º–µ—à–Ω–æ –∏–ª–∏ –æ—á–µ–Ω—å —á–µ—Å—Ç–Ω–æ ‚Äî –∑–Ω–∞—á–∏—Ç, –≤—Å—ë –∏–¥—ë—Ç –∫–∞–∫ –Ω–∞–¥–æ üíõ"
)

# =======================
# –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´
# =======================

@dataclass
class GameState:
    leader_id: int
    mode: Optional[str] = None
    index: int = 0
    answers: List[Tuple[int, str, str]] = field(default_factory=list)  # (user_id, name, text)
    saved_top: List[str] = field(default_factory=list)  # top-3 saved featured answers
    last_featured: Optional[str] = None  # last featured answer


games: Dict[int, GameState] = {}  # chat_id -> state


def get_questions(mode: str):
    return QUESTIONS_WINE if mode == MODE_WINE else QUESTIONS_COFFEE


def pick_mode_comment(mode: str) -> str:
    return random.choice(COMMENTS_WINE if mode == MODE_WINE else COMMENTS_COFFEE)


def kb_choose_mode() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup(row_width=2)
    kb.add(
        InlineKeyboardButton("üç∑ –í–ò–ù–û", callback_data="mode:wine"),
        InlineKeyboardButton("‚òï –ö–û–§–ï", callback_data="mode:coffee"),
    )
    return kb


def kb_ready() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup(row_width=1)
    kb.add(InlineKeyboardButton("–ì–û–¢–û–í–û ‚úÖ", callback_data="ready"))
    return kb


def kb_controls() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup(row_width=2)
    kb.add(
        InlineKeyboardButton("–î–ê–õ–¨–®–ï ‚ûú", callback_data="next"),
        InlineKeyboardButton("–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ üòÇ", callback_data="show_saved"),
    )
    return kb


def kb_save_featured() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup(row_width=1)
    kb.add(InlineKeyboardButton("–°–û–•–†–ê–ù–ò–¢–¨ üòÇ", callback_data="save_featured"))
    return kb


def kb_finish() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup(row_width=1)
    kb.add(InlineKeyboardButton("–ó–∞–≤–µ—Ä—à–∏—Ç—å ‚úÖ", callback_data="finish"))
    return kb


# =======================
# START
# =======================

@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    chat_id = message.chat.id

    # –í–µ–¥—É—â–∏–π = –ø–µ—Ä–≤—ã–π, –∫—Ç–æ –Ω–∞–∂–∞–ª /start –≤ —ç—Ç–æ–º —á–∞—Ç–µ
    if chat_id not in games:
        games[chat_id] = GameState(leader_id=message.from_user.id)

    await message.answer(
        "–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º:",
        reply_markup=kb_choose_mode()
    )


@dp.callback_query_handler(lambda c: c.data.startswith("mode:"))
async def choose_mode(callback: types.CallbackQuery):
    chat_id = callback.message.chat.id
    mode = callback.data.split(":", 1)[1]

    # –µ—Å–ª–∏ –∏–≥—Ä—ã –µ—â—ë –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º, –≤–µ–¥—É—â–∏–π = —Ç–æ—Ç, –∫—Ç–æ –Ω–∞—á–∞–ª —Ç—É—Ç —Å–µ–π—á–∞—Å
    if chat_id not in games:
        games[chat_id] = GameState(leader_id=callback.from_user.id)

    game = games[chat_id]
    game.mode = mode
    game.index = 0
    game.answers = []
    game.saved_top = []
    game.last_featured = None

    await callback.answer()
    await bot.send_message(
        chat_id,
        INSTRUCTION_TEXT,
        reply_markup=kb_ready()
    )


@dp.callback_query_handler(lambda c: c.data == "ready")
async def ready(callback: types.CallbackQuery):
    chat_id = callback.message.chat.id
    game = games.get(chat_id)

    if not game or not game.mode:
        await callback.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º üôÇ", show_alert=False)
        return

    # –¢–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏–≥—Ä—É
    if callback.from_user.id != game.leader_id:
        await callback.answer("–¢–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –º–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å ¬´–ì–û–¢–û–í–û¬ª üòä", show_alert=False)
        return

    await callback.answer()
    await send_question(chat_id)


# =======================
# –û–¢–ü–†–ê–í–ö–ê –í–û–ü–†–û–°–ê
# =======================

async def send_question(chat_id: int):
    game = games.get(chat_id)
    if not game or not game.mode:
        return

    questions = get_questions(game.mode)

    if game.index >= len(questions):
        final = FINAL_WINE if game.mode == MODE_WINE else FINAL_COFFEE
        await bot.send_message(chat_id, final, reply_markup=kb_finish())
        return

    game.answers = []
    game.last_featured = None

    q = questions[game.index]["q"]
    await bot.send_message(
        chat_id,
        f"‚ùì {q}\n\n"
        "–û—Ç–≤–µ—Ç—å—Ç–µ –≤ —á–∞—Ç–µ.\n"
        "–ö–æ–≥–¥–∞ –≤—Å–µ –≥–æ—Ç–æ–≤—ã ‚Äî –≤–µ–¥—É—â–∏–π –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–î–ê–õ–¨–®–ï¬ª",
        reply_markup=kb_controls()
    )


# =======================
# –°–ë–û–† –û–¢–í–ï–¢–û–í
# =======================

@dp.message_handler(content_types=types.ContentTypes.TEXT)
async def collect_answers(message: types.Message):
    chat_id = message.chat.id
    game = games.get(chat_id)
    if not game or not game.mode:
        return

    txt = (message.text or "").strip()
    if not txt or txt.startswith("/"):
        return

    uid = message.from_user.id if message.from_user else 0
    name = message.from_user.full_name if message.from_user else "–ö—Ç–æ-—Ç–æ"
    game.answers.append((uid, name, txt))

    # –í—ã–±–æ—Ä–æ—á–Ω–æ –∏ –Ω–µ—á–∞—Å—Ç–æ: —Å–º–µ—à–Ω–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ –æ—Ç–≤–µ—Ç
    if random.random() < 0.22:
        await message.reply(random.choice(FUNNY_REPLIES))


# =======================
# –ö–ù–û–ü–ö–ê –î–ê–õ–¨–®–ï
# =======================

@dp.callback_query_handler(lambda c: c.data == "next")
async def next_step(callback: types.CallbackQuery):
    chat_id = callback.message.chat.id
    game = games.get(chat_id)

    if not game or not game.mode:
        await callback.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return

    # –¢–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã
    if callback.from_user.id != game.leader_id:
        await callback.answer("–¢–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –º–æ–∂–µ—Ç –Ω–∞–∂–∏–º–∞—Ç—å ¬´–î–ê–õ–¨–®–ï¬ª üòä", show_alert=False)
        return

    if not game.answers:
        await callback.answer("–ü—É—Å—Ç—å –∫—Ç–æ-–Ω–∏–±—É–¥—å –æ—Ç–≤–µ—Ç–∏—Ç üòÑ", show_alert=False)
        return

    uid, name, text = random.choice(game.answers)
    featured = f"{name}: {text}"
    game.last_featured = featured

    await callback.answer()

    # –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç + —Ä–µ–∂–∏–º–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    await bot.send_message(
        chat_id,
        f"üí¨ {featured}\n\n{pick_mode_comment(game.mode)}",
        reply_markup=kb_save_featured()
    )

    game.index += 1
    await send_question(chat_id)


# =======================
# –°–û–•–†–ê–ù–ò–¢–¨ –¢–û–ü-3
# =======================

@dp.callback_query_handler(lambda c: c.data == "save_featured")
async def save_featured(callback: types.CallbackQuery):
    chat_id = callback.message.chat.id
    game = games.get(chat_id)

    if not game:
        await callback.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return

    # —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ö–∞–æ—Å–∞)
    if callback.from_user.id != game.leader_id:
        await callback.answer("–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π üòä", show_alert=False)
        return

    if not game.last_featured:
        await callback.answer("–ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å üòÑ")
        return

    if game.last_featured in game.saved_top:
        await callback.answer("–£–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ üòÇ")
        return

    if len(game.saved_top) >= 3:
        await callback.answer("–¢–æ–ø-3 —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω üòÇ", show_alert=False)
        return

    game.saved_top.append(game.last_featured)
    await callback.answer("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ üòÇ")


@dp.callback_query_handler(lambda c: c.data == "show_saved")
async def show_saved(callback: types.CallbackQuery):
    chat_id = callback.message.chat.id
    game = games.get(chat_id)

    if not game:
        await callback.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return

    await callback.answer()

    if not game.saved_top:
        await bot.send_message(chat_id, "–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ üòÑ")
        return

    text = "üòÇ –¢–æ–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ:\n\n" + "\n".join(
        [f"{i+1}) {item}" for i, item in enumerate(game.saved_top)]
    )
    await bot.send_message(chat_id, text)


# =======================
# –ó–ê–í–ï–†–®–ò–¢–¨
# =======================

@dp.callback_query_handler(lambda c: c.data == "finish")
async def finish(callback: types.CallbackQuery):
    chat_id = callback.message.chat.id
    game = games.get(chat_id)

    await callback.answer()

    if game and game.saved_top:
        text = "üòÇ –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ —Ä–∞–∑–æ–π—Ç–∏—Å—å ‚Äî –≤–∞—à —Ç–æ–ø:\n\n" + "\n".join(
            [f"{i+1}) {item}" for i, item in enumerate(game.saved_top)]
        )
        await bot.send_message(chat_id, text)

    games.pop(chat_id, None)
    await bot.send_message(chat_id, "–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ\n/start ‚Äî –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ")


# =======================
# –ó–ê–ü–£–°–ö
# =======================

if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
